<!DOCTYPE html>
<html lang="en">
    
    <head>
        <meta charset="utf-8" />
        
        <title></title>        
    </head>    
    <body>                
    </body>
        
    <script type="module">
        //core
        import DaMonster from './dist/core/damonster.js';
        import {DaCardType} from './dist/core/card.js';

        //web component                
        import DaPlayer from './dist/component/daplayer.js';
        import DaCard from './dist/component/dacard.js';
        import DaMonsterComponent from './dist/component/damonster.js';
        
        //utilities
        import Observable from './dist/utility/observable.js';
        
 
        var daMonster = window.daMonster = new DaMonster();   
                           
        //data binding to component...
        //swap whatever variable we needed to proxy so that we can do the binding....                                                        
        daMonster.players.forEach((p, index) =>{
        
            let daPlayerComponent = new DaPlayer();
                            
            Observable.addListener(p, 'hand', (newValue)=>{
                let cards = [];
                p.hand.forEach((c, index) =>{
                    cards.push({
                        'id': c.id,
                        'type': c.type,
                        'heroType': (c.type == DaCardType.Hero || c.type == DaCardType.Item ? c.heroType : ''),
                        'actionType': (c.type == DaCardType.Action ? c.action : ''),
                        'point': c.point
                    });
                    //cards += ( '[' + index + '-' + c.tostring() + '], ');
                });                
                daPlayerComponent.setAttribute('data-hand', JSON.stringify({'cards': cards}));
                //console.log(p.name + ' ' + newValue);
            });
            
            Observable.addListener(p, 'monsterKilled', (newValue)=>{
                 let cards = '';
                p.monsterKilled.forEach((c, index) =>{
                    cards += ( '[' + index + '-' + c.tostring() + '], ');
                });
                daPlayerComponent.setAttribute('data-monster-killed', cards);            
            });       
            
            Observable.addListener(p, 'hero', (newValue)=>{                                                                         
                if (newValue){                
                    let hero = {
                        'id': newValue.id,
                        'type': newValue.type,
                        'heroType': newValue.heroType,
                        'point': newValue.point
                    
                    };
                    daPlayerComponent.setAttribute('data-hero', JSON.stringify({'card': hero}));
                                                     
                    //remove existing listener and hook to new hero.item??                    
                    
                    //hook to new hero.item                
                    Observable.addListener(newValue, 'items', (newValue) =>{
                        let items = '';
                        p.hero.items.forEach((i, index) =>{
                            items += ( '[' + index + '-' + i.tostring() + '], ');
                        });
                        daPlayerComponent.setAttribute('data-hero-items', items);
                        daPlayerComponent.setAttribute('data-point', p.hero.totalPoint);                    
                    });
                    
                    daPlayerComponent.setAttribute('data-point', newValue.totalPoint);
                }else{
                    daPlayerComponent.setAttribute('data-hero', 'none');
                    daPlayerComponent.setAttribute('data-hero-items', 'None');
                    daPlayerComponent.setAttribute('data-point', 0);
                }    
                
                                                            
                           
            });
            
            daPlayerComponent.addEventListener('draw-from-deck', (e) =>{
                p.DrawFromDeck();
            });
            daPlayerComponent.addEventListener('play-action', (e) =>{
                let action = e.detail.name,
                    cardId = e.detail.cardId,
                    card = p.hand.find((c) => { 
                        return c.id == cardId;
                    });
                    
                switch(action){
                    case 'set-hero':
                        p.SetHero(card);                        
                    break;
                    
                    case 'equip-hero':
                        p.EquipHero(card);
                    break;
                    case 'play-action':
                        let args = e.detail.args;
                        //check if the card needs a target....
                        p.PlayAnAction(card, args);
                    break;
                }
            });
            daPlayerComponent.addEventListener('battle-ready', (e) =>{
                p.ReadyBattle();
            });
                                                                   
            document.body.appendChild(daPlayerComponent);
                                 
        });
        
        
        let daMonsterComponent = new DaMonsterComponent();
        Observable.addListener(daMonster, 'monster', (newValue)=>{
                let players = Array.from(document.body.getElementsByTagName('da-player'));                                                                                 
                if (newValue){                
                    let monster = {
                        'id': newValue.id,
                        'type': newValue.type,
                        'point': newValue.point                    
                    };
                    daMonsterComponent.setAttribute('data-card', JSON.stringify({'card': monster}));
                    players.forEach((p) => {
                        p.setAttribute('data-monster-invade', true);
                    });                    
                }else{
                    daMonsterComponent.setAttribute('data-card', JSON.stringify({'card': undefined}));
                    players.forEach((p) => {
                        p.setAttribute('data-monster-invade', false);
                    });                                        
                }
        });                                                                                  
        document.body.appendChild(daMonsterComponent);
       
       
       
        daMonster.New();
        
        //window.p = daMonster.players[0];
        //window.n = daMonster.players[1];

    </script>

</html>